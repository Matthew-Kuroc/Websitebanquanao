{% extends "admin/base_admin.html" %}

{% block page_title %}Tạo đơn hàng{% endblock %}

{% block title %}Tạo đơn hàng mới - Admin{% endblock %}

{% block content %}
<div class="max-w-6xl">
    <div class="mb-6">
        <a href="/admin/orders" class="text-indigo-600 hover:text-indigo-700">
            <i class="fas fa-arrow-left mr-2"></i>Quay lại danh sách đơn hàng
        </a>
    </div>

    <form method="POST" id="create-order-form" class="space-y-6">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Customer Info -->
            <div class="bg-white rounded-2xl shadow-sm p-6">
                <h3 class="text-xl font-bold mb-4">Thông tin khách hàng</h3>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Chọn khách hàng có sẵn</label>
                        <select id="customer_select" 
                                class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <option value="">-- Chọn khách hàng hoặc nhập thủ công --</option>
                            {% for customer in customers %}
                            <option value="{{ customer.email }}" 
                                    data-name="{{ customer.name }}" 
                                    data-phone="{{ customer.phone or '' }}" 
                                    data-address="{{ customer.address or '' }}">
                                {{ customer.name }} - {{ customer.email }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="border-t pt-4">
                        <p class="text-sm text-gray-500 mb-3">Hoặc nhập thông tin thủ công:</p>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Email khách hàng *</label>
                        <input type="email" name="customer_email" id="customer_email" required
                               class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Họ và tên *</label>
                        <input type="text" name="customer_name" id="customer_name" required
                               class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Số điện thoại *</label>
                        <input type="tel" name="customer_phone" id="customer_phone" required
                               class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Địa chỉ giao hàng *</label>
                        <textarea name="customer_address" id="customer_address" rows="3" required
                                  class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500"></textarea>
                    </div>
                </div>
            </div>

            <!-- Payment Info -->
            <div class="bg-white rounded-2xl shadow-sm p-6">
                <h3 class="text-xl font-bold mb-4">Thông tin thanh toán</h3>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Phương thức thanh toán *</label>
                        <select name="payment_method" required
                                class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <option value="cod">COD - Thanh toán khi nhận hàng</option>
                            <option value="banking">Chuyển khoản ngân hàng</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Trạng thái thanh toán *</label>
                        <select name="payment_status" required
                                class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <option value="pending">Chưa thanh toán</option>
                            <option value="paid">Đã thanh toán</option>
                            <option value="cod">COD</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Ghi chú</label>
                        <textarea name="notes" rows="3" placeholder="Ghi chú về đơn hàng..."
                                  class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500"></textarea>
                    </div>
                </div>
            </div>
        </div>

        <!-- Products Section -->
        <div class="bg-white rounded-2xl shadow-sm p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">Sản phẩm</h3>
                <button type="button" onclick="openProductModal()" 
                        class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition">
                    <i class="fas fa-plus mr-2"></i>Thêm sản phẩm
                </button>
            </div>

            <div id="selected-products" class="space-y-3">
                <p class="text-gray-500 text-center py-8">Chưa có sản phẩm nào. Nhấn "Thêm sản phẩm" để chọn.</p>
            </div>

            <!-- Summary -->
            <div class="border-t mt-6 pt-4 space-y-2">
                <div class="flex justify-between">
                    <span>Tạm tính:</span>
                    <span id="subtotal">0đ</span>
                </div>
                <div class="flex justify-between">
                    <span>Phí vận chuyển:</span>
                    <span id="shipping">30.000đ</span>
                </div>
                <div class="flex justify-between text-lg font-bold">
                    <span>Tổng cộng:</span>
                    <span id="total" class="text-red-600">30.000đ</span>
                </div>
            </div>
        </div>

        <!-- Hidden input for products JSON -->
        <input type="hidden" name="products" id="products-json" value="">

        <!-- Submit Button -->
        <div class="flex justify-end space-x-4">
            <a href="/admin/orders" class="px-6 py-3 border border-gray-300 rounded-lg hover:bg-gray-50 transition">
                Hủy
            </a>
            <button type="submit" class="bg-indigo-600 text-white px-6 py-3 rounded-lg hover:bg-indigo-700 transition font-semibold">
                <i class="fas fa-check mr-2"></i>Tạo đơn hàng
            </button>
        </div>
    </form>
</div>

<!-- Product Selection Modal -->
<div id="product-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden">
        <div class="p-6 border-b flex justify-between items-center">
            <h3 class="text-2xl font-bold">Chọn sản phẩm</h3>
            <button type="button" onclick="closeProductModal()" class="text-gray-500 hover:text-gray-700">
                <i class="fas fa-times text-2xl"></i>
            </button>
        </div>
        
        <div class="p-6 overflow-y-auto max-h-[70vh]">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                {% for product in products %}
                <div class="border rounded-lg p-4 hover:border-indigo-500 transition cursor-pointer" 
                     onclick="selectProduct('{{ product.id }}', '{{ product.name }}', {{ product.price }}, '{{ product.image }}')">
                    <div class="flex items-center space-x-4">
                        <img src="{{ product.image }}" alt="{{ product.name }}" class="w-20 h-20 object-cover rounded-lg">
                        <div class="flex-1">
                            <h4 class="font-semibold">{{ product.name }}</h4>
                            <p class="text-indigo-600 font-bold">{{ format_price(product.price) }}</p>
                            <p class="text-sm text-gray-500">Kho: {{ product.stock }}</p>
                        </div>
                        <button type="button" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700">
                            Chọn
                        </button>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<script>
let selectedProducts = [];

// Auto-fill customer info from datalist
document.getElementById('customer_email').addEventListener('input', function() {
    const email = this.value;
    const options = document.querySelectorAll('#customer-list option');
    
    options.forEach(option => {
        if (option.value === email) {
            document.getElementById('customer_name').value = option.getAttribute('data-name') || '';
            document.getElementById('customer_phone').value = option.getAttribute('data-phone') || '';
            document.getElementById('customer_address').value = option.getAttribute('data-address') || '';
        }
    });
});

function openProductModal() {
    document.getElementById('product-modal').classList.remove('hidden');
}

function closeProductModal() {
    document.getElementById('product-modal').classList.add('hidden');
}

function selectProduct(id, name, price, image) {
    // Check if product already exists
    const existingIndex = selectedProducts.findIndex(p => p.id === id);
    
    if (existingIndex >= 0) {
        // Increase quantity
        selectedProducts[existingIndex].qty++;
    } else {
        // Add new product
        selectedProducts.push({
            id: id,
            name: name,
            price: price,
            image: image,
            qty: 1,
            color: 'Mặc định',
            size: 'M'
        });
    }
    
    updateProductList();
    closeProductModal();
}

function removeProduct(index) {
    selectedProducts.splice(index, 1);
    updateProductList();
}

function updateQuantity(index, delta) {
    selectedProducts[index].qty += delta;
    if (selectedProducts[index].qty < 1) {
        selectedProducts[index].qty = 1;
    }
    updateProductList();
}

function updateProductList() {
    const container = document.getElementById('selected-products');
    
    if (selectedProducts.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-center py-8">Chưa có sản phẩm nào. Nhấn "Thêm sản phẩm" để chọn.</p>';
    } else {
        container.innerHTML = selectedProducts.map((product, index) => `
            <div class="flex items-center space-x-4 border rounded-lg p-4">
                <img src="${product.image}" alt="${product.name}" class="w-16 h-16 object-cover rounded-lg">
                <div class="flex-1">
                    <h4 class="font-semibold">${product.name}</h4>
                    <p class="text-indigo-600 font-bold">${formatPrice(product.price)}</p>
                </div>
                <div class="flex items-center space-x-2">
                    <button type="button" onclick="updateQuantity(${index}, -1)" 
                            class="w-8 h-8 bg-gray-200 rounded-lg hover:bg-gray-300">-</button>
                    <span class="w-12 text-center font-semibold">${product.qty}</span>
                    <button type="button" onclick="updateQuantity(${index}, 1)" 
                            class="w-8 h-8 bg-gray-200 rounded-lg hover:bg-gray-300">+</button>
                </div>
                <div class="font-bold">${formatPrice(product.price * product.qty)}</div>
                <button type="button" onclick="removeProduct(${index})" 
                        class="text-red-500 hover:text-red-700">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        `).join('');
    }
    
    updateTotals();
}

function updateTotals() {
    const subtotal = selectedProducts.reduce((sum, p) => sum + (p.price * p.qty), 0);
    const shipping = subtotal >= 500000 ? 0 : 30000;
    const total = subtotal + shipping;
    
    document.getElementById('subtotal').textContent = formatPrice(subtotal);
    document.getElementById('shipping').textContent = formatPrice(shipping);
    document.getElementById('total').textContent = formatPrice(total);
    
    // Update hidden input
    document.getElementById('products-json').value = JSON.stringify(selectedProducts);
}

function formatPrice(price) {
    return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(price);
}

// Auto-fill customer info when selecting from dropdown
document.getElementById('customer_select').addEventListener('change', function() {
    const selectedOption = this.options[this.selectedIndex];
    
    if (selectedOption.value) {
        document.getElementById('customer_email').value = selectedOption.value;
        document.getElementById('customer_name').value = selectedOption.dataset.name || '';
        document.getElementById('customer_phone').value = selectedOption.dataset.phone || '';
        document.getElementById('customer_address').value = selectedOption.dataset.address || '';
    } else {
        // Clear fields if "-- Chọn khách hàng --" is selected
        document.getElementById('customer_email').value = '';
        document.getElementById('customer_name').value = '';
        document.getElementById('customer_phone').value = '';
        document.getElementById('customer_address').value = '';
    }
});

// Form validation
document.getElementById('create-order-form').addEventListener('submit', function(e) {
    if (selectedProducts.length === 0) {
        e.preventDefault();
        alert('Vui lòng thêm ít nhất 1 sản phẩm vào đơn hàng');
        return false;
    }
});
</script>
{% endblock %}
