{% extends "admin/base_admin.html" %}

{% block page_title %}Đơn hàng{% endblock %}

{% block title %}Quản lý đơn hàng - Fashion Store{% endblock %}

{% block content %}
<div class="flex justify-between items-center mb-6">
    <div>
        <p class="text-gray-600">Tổng cộng {{ orders|length }} đơn hàng</p>
    </div>
    {% if session.user.role == 'admin' %}
    <a href="/admin/create-order" class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition font-semibold">
        <i class="fas fa-plus mr-2"></i>Tạo đơn hàng mới
    </a>
    {% endif %}
</div>

<div class="bg-white rounded-2xl shadow-sm">
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead>
                    <tr class="border-b border-gray-200">
                        <th class="text-left py-4 px-6">Mã đơn</th>
                        <th class="text-left py-4 px-6">Khách hàng</th>
                        <th class="text-left py-4 px-6">Ngày đặt</th>
                        <th class="text-left py-4 px-6">Tổng tiền</th>
                        <th class="text-left py-4 px-6">Trạng thái</th>
                        <th class="text-left py-4 px-6">Thao tác</th>
                    </tr>
                </thead>
                <tbody>
                    {% for order in orders %}
                    <tr class="border-b border-gray-200 hover:bg-gray-50">
                        <td class="py-4 px-6">#{{ order.id[:8] }}</td>
                        <td class="py-4 px-6">{{ order.user_email }}</td>
                        <td class="py-4 px-6">{{ order.created_at }}</td>
                        <td class="py-4 px-6">{{ format_price(order.total) }}</td>
                        <td class="py-4 px-6">
                            <span class="px-2 py-1 rounded-full text-xs font-medium 
                                {% if order.status == 'completed' %}bg-green-100 text-green-800
                                {% elif order.status == 'pending' %}bg-yellow-100 text-yellow-800
                                {% elif order.status == 'shipping' %}bg-blue-100 text-blue-800
                                {% else %}bg-gray-100 text-gray-800{% endif %}">
                                {{ order.status|title }}
                            </span>
                        </td>
                        <td class="py-4 px-6">
                            <div class="flex items-center gap-2 mb-2">
                                <a href="/admin/edit-order/{{ order.id }}" class="text-blue-600 hover:text-blue-800 text-sm">
                                    <i class="fas fa-edit"></i> Sửa
                                </a>
                                {% if session.user.role == 'admin' %}
                                <button onclick="deleteOrder('{{ order.id }}', '#{{ order.id[:8] }}')"
                                        class="text-red-600 hover:text-red-800 text-sm">
                                    <i class="fas fa-trash"></i> Xóa
                                </button>
                                {% endif %}
                            </div>
                            <form method="post" action="{{ url_for('update_order_status') }}" class="flex items-center space-x-2">
                                <input type="hidden" name="order_id" value="{{ order.id }}">
                                <select name="status" class="border border-gray-300 rounded px-2 py-1 text-sm">
                                    <option value="pending" {% if order.status == 'pending' %}selected{% endif %}>Chờ xử lý</option>
                                    <option value="shipping" {% if order.status == 'shipping' %}selected{% endif %}>Đang giao</option>
                                    <option value="completed" {% if order.status == 'completed' %}selected{% endif %}>Hoàn thành</option>
                                    <option value="cancelled" {% if order.status == 'cancelled' %}selected{% endif %}>Đã hủy</option>
                                </select>
                                <button type="submit" class="bg-indigo-600 text-white px-3 py-1 rounded text-sm hover:bg-indigo-700">
                                    Cập nhật
                                </button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

<!-- Delete Order Form -->
<form id="delete-order-form" method="POST" action="/admin/delete-order" style="display:none;">
    <input type="hidden" name="order_id" id="delete-order-id">
</form>

<script>
function deleteOrder(orderId, orderCode) {
    if (confirm('Bạn có chắc chắn muốn xóa đơn hàng ' + orderCode + '?\nHành động này không thể hoàn tác!')) {
        document.getElementById('delete-order-id').value = orderId;
        document.getElementById('delete-order-form').submit();
    }
}
</script>
{% endblock %}