<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Fashion Store - Thời trang hiện đại{% endblock %}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Inter', sans-serif; }
        .product-card { transition: all 0.3s ease; }
        .product-card:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .sale-badge { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        .star-rating { color: #fbbf24; }
        
        /* Dropdown styles with delay */
        .dropdown-menu {
            display: none;
            position: absolute;
            background: white;
            min-width: 200px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            border-radius: 0.5rem;
            z-index: 1000;
            margin-top: 0.5rem;
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
        }
        .dropdown-menu.show {
            display: block;
            opacity: 1;
        }
        .dropdown-menu a {
            display: block;
            padding: 0.5rem 1rem;
            color: #374151;
            text-decoration: none;
            transition: all 0.2s;
        }
        .dropdown-menu a:hover {
            background-color: #f3f4f6;
            color: #ff0000;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Announcement Bar -->
    <div class="bg-red-600 text-white text-center py-2 text-sm">
        <i class="fas fa-truck mr-2"></i> MIỄN PHÍ VẬN CHUYỂN CHO ĐƠN HÀNG TRÊN 500.000đ
    </div>

    <!-- Navigation -->
    <nav class="bg-white shadow-lg sticky top-0 z-50">
        <div class="container mx-auto px-4">
            <div class="flex items-center justify-between h-16">
                <!-- Logo -->
                <a href="{{ url_for('home') }}" class="flex items-center space-x-2 text-2xl font-bold text-red-600">
                    <img src="/Images/F_icon.png" alt="Logo" class="h-10 w-10 object-contain">
                    <span>FashionStore</span>
                </a>

                <!-- Desktop Menu -->
                <div class="hidden lg:flex items-center space-x-8">
                    <a href="{{ url_for('home') }}" class="text-gray-700 hover:text-red-600 font-medium">Trang chủ</a>
                    <a href="{{ url_for('products') }}" class="text-gray-700 hover:text-red-600 font-medium">Sản phẩm</a>
                    
                    <!-- Categories Dropdown -->
                    <div class="dropdown relative">
                        <button class="text-gray-700 hover:text-red-600 font-medium flex items-center focus:outline-none">
                            Danh mục <i class="fas fa-chevron-down ml-1 text-xs"></i>
                        </button>
                        <div class="dropdown-menu">
                            {% for category in get_categories() %}
                            <a href="{{ url_for('products') }}?category={{ category }}" class="block px-4 py-2 text-gray-700 hover:bg-red-50 hover:text-red-600 transition-colors">
                                {{ category }}
                            </a>
                            {% endfor %}
                        </div>
                    </div>
                    
                    <a href="{{ url_for('sale_products') }}" class="text-red-600 hover:text-red-700 font-medium">
                        <i class="fas fa-fire mr-1"></i>Sale
                    </a>
                </div>

                <!-- Mobile Menu Button -->
                <button class="lg:hidden text-gray-700 hover:text-red-600 focus:outline-none mobile-menu-button">
                    <i class="fas fa-bars text-xl"></i>
                </button>

                <!-- Search Bar -->
                <div class="hidden md:block flex-1 max-w-lg mx-4">
                    <form action="{{ url_for('products') }}" method="GET" class="relative">
                        <input type="text" name="q" placeholder="Tìm kiếm sản phẩm..." 
                               class="w-full px-4 py-2 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-transparent">
                        <button type="submit" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-red-600">
                            <i class="fas fa-search"></i>
                        </button>
                    </form>
                </div>

                <!-- User Actions -->
                <div class="flex items-center space-x-4">
                    <!-- Search Mobile -->
                    <button class="lg:hidden text-gray-700 hover:text-red-600 search-mobile-button">
                        <i class="fas fa-search text-xl"></i>
                    </button>

                    <!-- Wishlist -->
                    <a href="{{ url_for('wishlist') }}" class="relative text-gray-700 hover:text-red-600">
                        <i class="fas fa-heart text-xl"></i>
                        {% if wishlist_count() > 0 %}
                        <span class="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center">
                            {{ wishlist_count() }}
                        </span>
                        {% endif %}
                    </a>

                    <!-- Cart -->
                    <a href="{{ url_for('cart') }}" class="relative text-gray-700 hover:text-red-600">
                        <i class="fas fa-shopping-bag text-xl"></i>
                        {% if cart_count() > 0 %}
                        <span class="absolute -top-2 -right-2 bg-red-600 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center">
                            {{ cart_count() }}
                        </span>
                        {% endif %}
                    </a>

                    <!-- User Menu -->
                    {% if session.get('user') %}
                    <div class="dropdown relative">
                        <button class="flex items-center space-x-2 text-gray-700 hover:text-red-600 focus:outline-none">
                            <i class="fas fa-user-circle text-xl"></i>
                            <span class="hidden sm:block">{{ session['user']['name'] }}</span>
                            <i class="fas fa-chevron-down text-xs"></i>
                        </button>
                        <div class="dropdown-menu right-0">
                            <a href="{{ url_for('profile') }}" class="block px-4 py-2 text-gray-700 hover:bg-red-50">
                                <i class="fas fa-user mr-2"></i>Tài khoản
                            </a>
                            <a href="{{ url_for('my_orders') }}" class="block px-4 py-2 text-gray-700 hover:bg-red-50">
                                <i class="fas fa-box mr-2"></i>Đơn hàng
                            </a>
                            {% if session['user']['role'] in ['admin', 'staff'] %}
                            <a href="{{ url_for('admin_dashboard') }}" class="block px-4 py-2 text-red-600 hover:bg-red-50">
                                <i class="fas fa-cog mr-2"></i>Quản trị
                            </a>
                            {% endif %}
                            <hr class="my-2">
                            <a href="{{ url_for('logout') }}" class="block px-4 py-2 text-red-600 hover:bg-red-50">
                                <i class="fas fa-sign-out-alt mr-2"></i>Đăng xuất
                            </a>
                        </div>
                    </div>
                    {% else %}
                    <div class="hidden lg:flex items-center space-x-2">
                        <a href="{{ url_for('login') }}" class="px-4 py-2 text-red-600 hover:text-red-700 font-medium">
                            Đăng nhập
                        </a>
                        <a href="{{ url_for('register') }}" class="px-4 py-2 bg-red-600 text-white rounded-full hover:bg-red-700 font-medium">
                            Đăng ký
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Mobile Menu -->
            <div class="mobile-menu hidden lg:hidden py-4 border-t border-gray-200">
                <div class="space-y-2">
                    <a href="{{ url_for('home') }}" class="block py-2 px-4 text-gray-700 hover:bg-red-50 rounded">Trang chủ</a>
                    <a href="{{ url_for('products') }}" class="block py-2 px-4 text-gray-700 hover:bg-red-50 rounded">Sản phẩm</a>
                    
                    <!-- Mobile Categories -->
                    <div class="px-4 py-2">
                        <div class="font-medium text-gray-700 mb-2">Danh mục</div>
                        <div class="space-y-1 ml-4">
                            {% for category in get_categories() %}
                            <a href="{{ url_for('products') }}?category={{ category }}" class="block py-2 text-gray-600 hover:text-red-600">
                                {{ category }}
                            </a>
                            {% endfor %}
                        </div>
                    </div>
                    
                    <a href="{{ url_for('sale_products') }}" class="block py-2 px-4 text-red-600 hover:bg-red-50 rounded">
                        <i class="fas fa-fire mr-2"></i>Sale
                    </a>
                    
                    {% if not session.get('user') %}
                    <div class="pt-4 border-t border-gray-200">
                        <a href="{{ url_for('login') }}" class="block py-2 px-4 text-red-600 hover:bg-red-50 rounded">Đăng nhập</a>
                        <a href="{{ url_for('register') }}" class="block py-2 px-4 bg-red-600 text-white rounded hover:bg-red-700">Đăng ký</a>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Mobile Search -->
            <div class="mobile-search hidden lg:hidden py-4 border-t border-gray-200">
                <form action="{{ url_for('products') }}" method="GET" class="relative">
                    <input type="text" name="q" placeholder="Tìm kiếm sản phẩm..." 
                           class="w-full px-4 py-2 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-red-500">
                    <button type="submit" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-red-600">
                        <i class="fas fa-search"></i>
                    </button>
                </form>
            </div>
        </div>
    </nav>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="container mx-auto px-4 mt-4">
                {% for category, message in messages %}
                    <div class="p-4 rounded-lg mb-2 {% if category == 'error' %}bg-red-100 text-red-800 border border-red-200{% else %}bg-green-100 text-green-800 border border-green-200{% endif %}">
                        <div class="flex items-center">
                            <i class="fas {% if category == 'error' %}fa-exclamation-circle{% else %}fa-check-circle{% endif %} mr-2"></i>
                            {{ message }}
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <!-- Main Content -->
    <main class="min-h-screen">
        {% block content %}{% endblock %}
    </main>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white mt-16">
        <div class="container mx-auto px-4 py-12">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
                <div>
                    <h3 class="font-bold text-lg mb-4">Về chúng tôi</h3>
                    <p class="text-gray-400 text-sm">
                        Fashion Store - Điểm đến thời trang hàng đầu với những
                        xu hướng mới nhất và chất lượng tốt nhất.
                        Chúng tôi cam kết mang đến trải nghiệm
                        mua sắm tuyệt vời nhất.
                    </p>
                </div>
                <div>
                    <h3 class="font-bold text-lg mb-4">Hỗ trợ</h3>
                    <ul class="space-y-2 text-sm text-gray-400">
                        <li><a href="#" class="hover:text-white transition"><i class="fas fa-chevron-right mr-2 text-xs"></i>Chính sách đổi trả</a></li>
                        <li><a href="#" class="hover:text-white transition"><i class="fas fa-chevron-right mr-2 text-xs"></i>Hướng dẫn mua hàng</a></li>
                        <li><a href="#" class="hover:text-white transition"><i class="fas fa-chevron-right mr-2 text-xs"></i>Chính sách bảo mật</a></li>
                        <li><a href="#" class="hover:text-white transition"><i class="fas fa-chevron-right mr-2 text-xs"></i>Điều khoản dịch vụ</a></li>
                    </ul>
                </div>
                <div>
                    <h3 class="font-bold text-lg mb-4">Liên hệ</h3>
                    <ul class="space-y-2 text-sm text-gray-400">
                        <li><i class="fas fa-phone mr-2"></i> +84 123 456 789</li>
                        <li><i class="fas fa-envelope mr-2"></i> support@fashion.vn</li>
                        <li><i class="fas fa-map-marker-alt mr-2"></i> 140 Lê Trọng Tấn, P.Tây Thạnh, Q.Tân Phú, TP.HCM</li>
                        <li><i class="fas fa-clock mr-2"></i> 8:00 - 22:00 hàng ngày</li>
                    </ul>
                </div>
                <div>
                    <h3 class="font-bold text-lg mb-4">Theo dõi chúng tôi</h3>
                    <p class="text-gray-400 text-sm mb-4">Cập nhật xu hướng thời trang mới nhất</p>
                    <div class="flex space-x-4 text-2xl">
                        <a href="#" class="hover:text-red-400 transition"><i class="fab fa-facebook"></i></a>
                        <a href="#" class="hover:text-red-400 transition"><i class="fab fa-instagram"></i></a>
                        <a href="#" class="hover:text-red-400 transition"><i class="fab fa-tiktok"></i></a>
                        <a href="#" class="hover:text-red-400 transition"><i class="fab fa-youtube"></i></a>
                    </div>
                    <div class="mt-4">
                        <h4 class="font-semibold mb-2">Đăng ký nhận tin</h4>
                        <form class="flex">
                            <input type="email" placeholder="Email của bạn" class="flex-1 px-3 py-2 text-gray-800 rounded-l focus:outline-none">
                            <button type="submit" class="bg-red-600 px-4 py-2 rounded-r hover:bg-red-700">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </form>
                    </div>
                </div>
            </div>
            <div class="border-t border-gray-700 mt-8 pt-8 text-center text-sm text-gray-400">
                <p>© {{ now.year }} Fashion Store. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script>
        // Mobile menu functionality
        document.addEventListener('DOMContentLoaded', function() {
            const mobileMenuButton = document.querySelector('.mobile-menu-button');
            const mobileMenu = document.querySelector('.mobile-menu');
            const searchMobileButton = document.querySelector('.search-mobile-button');
            const mobileSearch = document.querySelector('.mobile-search');

            // Toggle mobile menu
            if (mobileMenuButton && mobileMenu) {
                mobileMenuButton.addEventListener('click', function() {
                    mobileMenu.classList.toggle('hidden');
                    mobileSearch.classList.add('hidden');
                });
            }

            // Toggle mobile search
            if (searchMobileButton && mobileSearch) {
                searchMobileButton.addEventListener('click', function() {
                    mobileSearch.classList.toggle('hidden');
                    mobileMenu.classList.add('hidden');
                });
            }

            // Close mobile menu when clicking outside
            document.addEventListener('click', function(event) {
                if (!event.target.closest('.mobile-menu-button') && !event.target.closest('.mobile-menu')) {
                    mobileMenu.classList.add('hidden');
                }
                if (!event.target.closest('.search-mobile-button') && !event.target.closest('.mobile-search')) {
                    mobileSearch.classList.add('hidden');
                }
            });

            // Handle dropdown menus for desktop with delay
            const dropdowns = document.querySelectorAll('.dropdown');
            dropdowns.forEach(dropdown => {
                const button = dropdown.querySelector('button');
                const menu = dropdown.querySelector('.dropdown-menu');
                let hideTimeout;

                // Show on hover for desktop
                dropdown.addEventListener('mouseenter', function() {
                    if (window.innerWidth >= 1024) {
                        clearTimeout(hideTimeout);
                        menu.classList.add('show');
                    }
                });

                dropdown.addEventListener('mouseleave', function() {
                    if (window.innerWidth >= 1024) {
                        // Add 300ms delay before hiding
                        hideTimeout = setTimeout(() => {
                            menu.classList.remove('show');
                        }, 300);
                    }
                });

                // Keep menu open when mouse is over it
                menu.addEventListener('mouseenter', function() {
                    if (window.innerWidth >= 1024) {
                        clearTimeout(hideTimeout);
                        menu.classList.add('show');
                    }
                });

                menu.addEventListener('mouseleave', function() {
                    if (window.innerWidth >= 1024) {
                        hideTimeout = setTimeout(() => {
                            menu.classList.remove('show');
                        }, 300);
                    }
                });

                // Toggle on click for mobile
                if (button && menu) {
                    button.addEventListener('click', function(e) {
                        if (window.innerWidth < 1024) {
                            e.preventDefault();
                            // Close other dropdowns
                            dropdowns.forEach(otherDropdown => {
                                if (otherDropdown !== dropdown) {
                                    otherDropdown.querySelector('.dropdown-menu').classList.remove('show');
                                }
                            });
                            // Toggle current dropdown
                            menu.classList.toggle('show');
                        }
                    });
                }
            });

            // Close dropdowns when clicking outside
            document.addEventListener('click', function(event) {
                if (!event.target.closest('.dropdown')) {
                    dropdowns.forEach(dropdown => {
                        dropdown.querySelector('.dropdown-menu').classList.remove('show');
                    });
                }
            });
        });

        // Add to wishlist function
        function addToWishlist(pid) {
            fetch('{{ url_for("add_to_wishlist") }}', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({pid: pid})
            }).then(r => r.json()).then(data => {
                if (data.success) {
                    showNotification('Đã thêm vào yêu thích!', 'success');
                    location.reload();
                } else {
                    showNotification('Vui lòng đăng nhập để sử dụng tính năng này', 'error');
                }
            }).catch(error => {
                showNotification('Có lỗi xảy ra, vui lòng thử lại', 'error');
            });
        }

        function toggleWishlist(btn, pid) {
            // 1. Tìm thẻ icon trái tim bên trong nút bấm
            const icon = btn.querySelector('i');

            // 2. Kiểm tra: Nếu icon có class 'fas' (Solid) nghĩa là ĐÃ LIKE
            const isLiked = icon.classList.contains('fas');

            // 3. Quyết định gọi API nào
            const url = isLiked ? '/remove-from-wishlist' : '/add-to-wishlist';

            fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ pid: pid })
            })
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        // Thông báo và tải lại trang
                        showNotification(isLiked ? 'Đã xóa khỏi yêu thích' : 'Đã thêm vào yêu thích', 'success');
                        location.reload();
                    } else {
                        showNotification('Vui lòng đăng nhập để sử dụng tính năng này', 'error');
                        if (!data.success && !data.error) window.location.href = '/login';
                    }
                })
                .catch(error => console.error('Error:', error));
        }

        // Remove from wishlist function
        function removeFromWishlist(pid) {
            fetch('{{ url_for("remove_from_wishlist") }}', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({pid: pid})
            }).then(r => r.json()).then(data => {
                if (data.success) {
                    showNotification('Đã xóa khỏi yêu thích', 'success');
                    location.reload();
                }
            });
        }

        // Notification function
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg text-white ${
                type === 'success' ? 'bg-green-500' : 
                type === 'error' ? 'bg-red-500' : 'bg-blue-500'
            }`;
            notification.innerHTML = `
                <div class="flex items-center">
                    <i class="fas ${
                        type === 'success' ? 'fa-check-circle' : 
                        type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'
                    } mr-2"></i>
                    <span>${message}</span>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Product image zoom
        function zoomImage(element) {
            element.style.transform = 'scale(1.05)';
            element.style.transition = 'transform 0.3s ease';
        }

        function resetZoom(element) {
            element.style.transform = 'scale(1)';
        }
    </script>
</body>
</html>